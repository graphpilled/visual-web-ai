<!DOCTYPE html>
<html>
<head>
  <title>Scan Operations Test (CumSum, CumProd, Reverse)</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
    pre { background: #16213e; padding: 15px; border-radius: 8px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Scan Operations Test</h1>
  <pre id="output"></pre>
  <script type="module">
    import { GPURuntime, GraphExecutor } from '../src/runtime.js';
    import { Compiler } from '../dist/bundle.js';
    
    const log = (msg) => {
      document.getElementById('output').textContent += msg + '\n';
      console.log(msg);
    };
    
    async function runTests() {
      log('=== Scan Operations Tests ===\n');
      
      const runtime = new GPURuntime();
      await runtime.init();
      log('✓ Runtime initialized\n');

      // Test 1: CumSum (already tested, but verify still works)
      log('Test 1: CumSum (cumulative sum)');
      try {
        const graph1 = Compiler.createGraph();
        const x1 = Compiler.input(graph1, [5], "input");
        const y1 = Compiler.cumsum(graph1, x1, 0);
        Compiler.markOutput(graph1, y1);
        const compiled1 = Compiler.compile(graph1);
        const executor1 = new GraphExecutor(runtime, compiled1);
        await executor1.init();
        
        const input1 = new Float32Array([1, 2, 3, 4, 5]);
        const output1 = await executor1.execute(input1);
        log(`  Input: [${Array.from(input1)}]`);
        log(`  CumSum: [${Array.from(output1)}]`);
        log(`  Expected: [1, 3, 6, 10, 15]`);
        const expected1 = [1, 3, 6, 10, 15];
        const pass1 = expected1.every((v, i) => Math.abs(output1[i] - v) < 0.01);
        log(`  ${pass1 ? 'PASS ✓' : 'FAIL ✗'}\n`);
        executor1.destroy();
      } catch (e) {
        log(`  FAIL ✗: ${e.message}\n`);
        console.error(e);
      }

      // Test 2: CumProd (cumulative product)
      log('Test 2: CumProd (cumulative product)');
      try {
        const graph2 = Compiler.createGraph();
        const x2 = Compiler.input(graph2, [5], "input");
        const y2 = Compiler.cumprod(graph2, x2, 0);
        Compiler.markOutput(graph2, y2);
        const compiled2 = Compiler.compile(graph2);
        const executor2 = new GraphExecutor(runtime, compiled2);
        await executor2.init();
        
        const input2 = new Float32Array([1, 2, 3, 4, 5]);
        const output2 = await executor2.execute(input2);
        log(`  Input: [${Array.from(input2)}]`);
        log(`  CumProd: [${Array.from(output2)}]`);
        log(`  Expected: [1, 2, 6, 24, 120]`);
        const expected2 = [1, 2, 6, 24, 120];
        const pass2 = expected2.every((v, i) => Math.abs(output2[i] - v) < 0.01);
        log(`  ${pass2 ? 'PASS ✓' : 'FAIL ✗'}\n`);
        executor2.destroy();
      } catch (e) {
        log(`  FAIL ✗: ${e.message}\n`);
        console.error(e);
      }

      // Test 3: Reverse (1D)
      log('Test 3: Reverse (1D tensor)');
      try {
        const graph3 = Compiler.createGraph();
        const x3 = Compiler.input(graph3, [5], "input");
        const y3 = Compiler.reverse(graph3, x3, [0]);
        Compiler.markOutput(graph3, y3);
        const compiled3 = Compiler.compile(graph3);
        const executor3 = new GraphExecutor(runtime, compiled3);
        await executor3.init();
        
        const input3 = new Float32Array([1, 2, 3, 4, 5]);
        const output3 = await executor3.execute(input3);
        log(`  Input: [${Array.from(input3)}]`);
        log(`  Reverse axis 0: [${Array.from(output3)}]`);
        log(`  Expected: [5, 4, 3, 2, 1]`);
        const expected3 = [5, 4, 3, 2, 1];
        const pass3 = expected3.every((v, i) => Math.abs(output3[i] - v) < 0.01);
        log(`  ${pass3 ? 'PASS ✓' : 'FAIL ✗'}\n`);
        executor3.destroy();
      } catch (e) {
        log(`  FAIL ✗: ${e.message}\n`);
        console.error(e);
      }

      // Test 4: Reverse (2D along axis 1)
      log('Test 4: Reverse (2D tensor along axis 1)');
      try {
        const graph4 = Compiler.createGraph();
        const x4 = Compiler.input(graph4, [2, 4], "input");
        const y4 = Compiler.reverse(graph4, x4, [1]);  // reverse columns
        Compiler.markOutput(graph4, y4);
        const compiled4 = Compiler.compile(graph4);
        const executor4 = new GraphExecutor(runtime, compiled4);
        await executor4.init();
        
        // [[1,2,3,4], [5,6,7,8]] -> [[4,3,2,1], [8,7,6,5]]
        const input4 = new Float32Array([1, 2, 3, 4, 5, 6, 7, 8]);
        const output4 = await executor4.execute(input4);
        log(`  Input: [[1,2,3,4], [5,6,7,8]]`);
        log(`  Reverse axis 1: [${Array.from(output4)}]`);
        log(`  Expected: [4,3,2,1, 8,7,6,5]`);
        const expected4 = [4, 3, 2, 1, 8, 7, 6, 5];
        const pass4 = expected4.every((v, i) => Math.abs(output4[i] - v) < 0.01);
        log(`  ${pass4 ? 'PASS ✓' : 'FAIL ✗'}\n`);
        executor4.destroy();
      } catch (e) {
        log(`  FAIL ✗: ${e.message}\n`);
        console.error(e);
      }

      // Test 5: CumSum on 2D tensor along axis 1
      log('Test 5: CumSum (2D tensor along axis 1)');
      try {
        const graph5 = Compiler.createGraph();
        const x5 = Compiler.input(graph5, [2, 4], "input");
        const y5 = Compiler.cumsum(graph5, x5, 1);
        Compiler.markOutput(graph5, y5);
        const compiled5 = Compiler.compile(graph5);
        const executor5 = new GraphExecutor(runtime, compiled5);
        await executor5.init();
        
        // [[1,2,3,4], [5,6,7,8]] -> [[1,3,6,10], [5,11,18,26]]
        const input5 = new Float32Array([1, 2, 3, 4, 5, 6, 7, 8]);
        const output5 = await executor5.execute(input5);
        log(`  Input: [[1,2,3,4], [5,6,7,8]]`);
        log(`  CumSum axis 1: [${Array.from(output5)}]`);
        log(`  Expected: [1,3,6,10, 5,11,18,26]`);
        const expected5 = [1, 3, 6, 10, 5, 11, 18, 26];
        const pass5 = expected5.every((v, i) => Math.abs(output5[i] - v) < 0.01);
        log(`  ${pass5 ? 'PASS ✓' : 'FAIL ✗'}\n`);
        executor5.destroy();
      } catch (e) {
        log(`  FAIL ✗: ${e.message}\n`);
        console.error(e);
      }

      runtime.destroy();
      log('=== All Scan Operations Tests Completed ===');
    }
    
    runTests();
  </script>
</body>
</html>
